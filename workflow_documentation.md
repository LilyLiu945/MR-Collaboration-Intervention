# 混合现实协作干预时机预测 - 完整工作流程文档

## 项目概述

**目标**：预测混合现实（MR）协作环境中系统干预的最佳时机，以改善团队协作效率。

**数据集**：多模态群体交互数据集

- 12个小组的独立交流数据
- 每个组约5-10分钟的会话时间
- 32秒时间窗口

**核心挑战**：

- 每个组的数据独立，不能跨组进行时间序列分析
- 数据不平衡（需要干预的窗口占少数）
- 需要同时考虑组间差异和时间顺序

---

## 阶段0：数据准备与划分

### 0.1 数据加载

加载三个数据源：

- `pairwise_features.csv`：成对交互特征（speaking entropy, dominance ratio, joint attention等）
- `windowed_metrics.csv`：窗口级网络指标（density, reciprocity, centrality等）
- `task_metrics_summary.csv`：任务性能指标（completion time, interaction diversity等）

### 0.2 数据划分策略（方案C：混合划分）

#### 第一步：按组划分（12组）

```
训练组：组1-8（8组，66.7%）
验证组：组9-10（2组，16.7%）
测试组：组11-12（2组，16.7%）
```

#### 第二步：训练组内部按时间划分

```
训练组（组1-8）：
  - 前70%窗口 → 训练集（用于训练模型参数）
  - 后30%窗口 → 训练验证集（用于early stopping）

验证组（组9-10）：
  - 全部窗口 → 验证集（用于模型选择）

测试组（组11-12）：
  - 全部窗口 → 测试集（用于最终评估）
```

#### 数据使用规则

| 数据集               | 用途                                     | 说明                                 |
| -------------------- | ---------------------------------------- | ------------------------------------ |
| **训练集**     | 训练模型参数、HMM训练、特征选择          | 训练组的前70%窗口                    |
| **训练验证集** | Early stopping、Learning rate scheduling | 训练组的后30%窗口                    |
| **验证集**     | 模型选择、超参数优化                     | 验证组的全部窗口                     |
| **测试集**     | 最终评估                                 | 测试组的全部窗口（绝对不能用于训练） |

### 0.3 特征工程

1. **聚合成对特征到窗口级别**

   - 每个窗口内的成对特征 → 均值、标准差、最大值、最小值
2. **整合窗口级网络指标**

   - 合并不同模态的网络指标（conversation, proximity, shared_attention, fused）
3. **添加任务性能特征**

   - 任务完成度、交互多样性等
4. **处理缺失值**

   - 前向填充、后向填充、插值
5. **特征标准化**

   - 使用训练集的均值和标准差标准化所有数据

---

## 阶段1：无监督特征重要性分析

### 1.1 特征选择方法（仅使用训练集）

#### 方法1：方差分析

- 移除方差接近0的特征（无变化特征）

#### 方法2：相关性分析

- 计算特征间相关性
- 移除高度相关的特征（保留一个代表性特征）

#### 方法3：主成分分析（PCA）

- 分析主成分贡献率
- 识别最重要的原始特征

#### 方法4：聚类分析

- 使用K-means对窗口聚类
- 分析哪些特征最能区分不同聚类
- 使用特征重要性评分

#### 方法5：互信息分析

- 计算特征与聚类标签的互信息
- 选择互信息高的特征

### 1.2 特征子集确定

**输出**：

- 特征重要性排序
- 选择Top-K特征（例如Top-30或Top-50，K由验证集性能决定）
- 特征选择报告

**特征覆盖维度**：

- 通信特征（speaking entropy, dominance ratio）
- 空间特征（proximity metrics）
- 注意力特征（shared attention）
- 网络特征（density, reciprocity, centrality）
- 任务特征（completion metrics）

---

## 阶段2：HMM建模（得到Y标签）

### 2.1 HMM架构（方案B：激进改进）

#### 层次化HMM设计

**第一层：粗粒度状态（3-4个状态）**

- 状态1：高通信状态（balanced collaboration）
- 状态2：中等通信状态（moderate collaboration）
- 状态3：低通信状态（low collaboration）
- 状态4（可选）：极低通信状态（very low collaboration）

**第二层：细粒度状态（针对低通信状态）**

- 对低通信状态进一步细分：
  - 低通信-需要干预（imbalanced, disengaged）
  - 低通信-暂时性（temporary low）
  - 低通信-恢复中（recovering）

#### HMM技术细节

- **HMM类型**：GaussianHMM（连续观测值）
- **观测值**：选择的Top-K特征
- **状态数**：粗粒度3-4个，细粒度2-3个

### 2.2 HMM训练（仅使用训练集）

**输入**：

- 训练集的特征矩阵（Top-K特征）
- 每个组的窗口序列（保持时间顺序）

**训练过程**：

1. 对每个训练组，提取窗口序列
2. 使用GaussianHMM训练：
   - 初始化：K-means聚类初始化状态
   - 训练：Baum-Welch算法（EM算法）
   - 状态数：3-4个（粗粒度）
3. 对低通信状态，训练细粒度HMM：
   - 仅使用低通信状态的窗口
   - 状态数：2-3个（细粒度）

**输出**：

- 训练好的HMM模型
- 状态转移概率矩阵
- 状态发射概率分布

### 2.3 HMM预测（得到Y标签）

对所有数据（训练集、训练验证集、验证集、测试集）进行状态预测：

1. **使用训练好的HMM预测每个窗口的状态**
2. **状态到Y标签的映射**（二分类）：

   - 高通信状态 → Y=0（不需要干预）
   - 中等通信状态 → Y=0（不需要干预）
   - 低通信-需要干预 → Y=1（需要干预）
   - 低通信-暂时性 → Y=0（不需要干预）
   - 低通信-恢复中 → Y=0（不需要干预）
3. **或者使用多分类**：

   - Y=0：高通信
   - Y=1：中等通信
   - Y=2：低通信-需要干预
   - Y=3：低通信-暂时性

**输出**：

- Y_train：训练集的标签
- Y_train_val：训练验证集的标签
- Y_val：验证集的标签
- Y_test：测试集的标签

### 2.4 HMM分析

**分析内容**：

- 状态分布：每个状态占多少窗口
- 状态转移：状态之间的转换模式
- 状态持续时间：每个状态平均持续多久
- 状态与任务性能的关系：不同状态下的任务完成情况

---

## 阶段2.5：有监督特征重要性分析（使用HMM得到的Y标签）

### 2.5.1 为什么需要这一步？

**重要**：现在有了Y标签（来自HMM预测），可以进行有监督的特征重要性分析，可能会发现：

- 哪些特征对预测Y（是否需要干预）最重要
- 无监督方法可能遗漏了一些对Y预测重要的特征
- 可以进一步优化特征子集，提高时间序列模型的性能

### 2.5.2 特征重要性分析方法（仅使用训练集）

#### 方法1：基于树模型的特征重要性

- 使用Random Forest或XGBoost训练分类器
- 使用HMM得到的Y_train作为目标变量
- 提取特征重要性分数
- 选择重要性高的特征

#### 方法2：互信息分析

- 计算每个特征与Y_train的互信息
- 选择互信息高的特征

#### 方法3：递归特征消除（RFE）

- 使用分类器（如SVM、Random Forest）
- 递归地移除最不重要的特征
- 选择最优特征子集

#### 方法4：LASSO正则化

- 使用LASSO回归/分类
- 自动选择重要特征（系数非零的特征）

#### 方法5：SHAP值分析（可解释性）

- 使用SHAP值计算每个特征对预测的贡献
- 选择SHAP值高的特征

### 2.5.3 特征子集重新确定

**输入**：

- 阶段1选择的Top-K特征（或所有特征）
- Y_train（HMM预测的标签）

**过程**：

1. 使用多种方法计算特征重要性
2. 综合评分（例如：树模型重要性 + 互信息 + SHAP值）
3. 选择Top-M特征（M ≤ K，例如Top-20或Top-30，M由验证集性能决定）
4. 确保特征覆盖多个维度

**输出**：

- 最终特征重要性排序
- 选择的Top-M特征列表（用于时间序列模型）
- 有监督特征选择报告

**验证**：

- 使用选择的特征在训练验证集上评估简单分类器性能
- 如果性能下降，调整M值或重新选择特征

**注意**：

- 这一步是在阶段1无监督特征选择的基础上，进一步优化特征子集
- 最终选择的特征将用于时间序列模型训练

---

## 阶段3：时间序列模型训练

### 3.1 序列构建（关键：每个组独立）

#### 函数设计

```python
create_sequences_by_group(data, group_id, sequence_length=10, selected_features)
```

**输入**：

- data：该组的所有窗口数据（已按时间排序）
- group_id：组ID
- sequence_length：历史窗口数（例如10个窗口 = 320秒历史）
- selected_features：阶段2.5最终选择的Top-M特征列表

**过程**：

1. 提取该组的所有窗口（按时间排序）
2. **只使用最终选择的特征**（selected_features，来自阶段2.5）
3. 对每个窗口t，使用窗口[t-sequence_length:t]的特征作为输入
4. 使用窗口t的Y标签（来自HMM预测）作为输出
5. **确保不跨组**（每个组的序列独立）

**输出**：

- X_sequences：形状为 (n_sequences, sequence_length, n_selected_features)
- Y_labels：形状为 (n_sequences,)

**重要原则**：

- ✅ 每个组的序列独立构建
- ✅ 不跨组创建序列
- ✅ 保持时间顺序
- ✅ 只使用最终选择的特征（阶段2.5的Top-M特征）

### 3.2 模型架构

#### 模型1：LSTM

```
输入层：序列长度 × 特征数
LSTM层1：128 units，return_sequences=True
Dropout：0.3
LSTM层2：64 units，return_sequences=False
Dropout：0.3
Dense层：32 units
输出层：sigmoid（二分类）或softmax（多分类）
```

#### 模型2：GRU

```
输入层：序列长度 × 特征数
GRU层1：128 units，return_sequences=True
Dropout：0.3
GRU层2：64 units，return_sequences=False
Dropout：0.3
Dense层：32 units
输出层：sigmoid或softmax
```

#### 模型3：Transformer

```
输入嵌入层
位置编码
Transformer编码器层（多头注意力）
全局平均池化
Dense层：64 units
输出层：sigmoid或softmax
```

#### 模型4：多尺度时间窗口（可选）

- 短序列（5窗口）：捕捉短期变化
- 中序列（10窗口）：标准序列
- 长序列（20窗口）：捕捉长期趋势
- 融合层：合并三个尺度的输出

### 3.3 模型训练

#### 数据准备

- X_train, Y_train：训练集的序列和标签
- X_train_val, Y_train_val：训练验证集的序列和标签（用于early stopping）

#### 训练配置

- **优化器**：Adam（learning_rate=0.001）
- **损失函数**：binary_crossentropy（二分类）或categorical_crossentropy（多分类）
- **评估指标**：accuracy, precision, recall, f1_score
- **Batch size**：32或64
- **Epochs**：100（early stopping）

#### 回调函数

1. **EarlyStopping**

   - monitor='val_loss'
   - patience=10
   - restore_best_weights=True
2. **ReduceLROnPlateau**

   - monitor='val_loss'
   - factor=0.5
   - patience=5
3. **ModelCheckpoint**

   - 保存最佳模型

#### 训练过程

- 使用训练集训练
- 使用训练验证集进行验证（early stopping）
- **不接触验证集和测试集**

### 3.4 模型选择（使用验证集）

对每个模型（LSTM、GRU、Transformer）：

1. 在验证集上评估性能
2. 计算指标：
   - Accuracy
   - Precision
   - Recall
   - F1 Score
   - AUC-ROC（二分类）
   - 混淆矩阵

**选择标准**：

- 主要指标：F1 Score（考虑数据不平衡）
- 次要指标：AUC-ROC
- 选择在验证集上表现最好的模型

---

## 阶段4：模型评估与报告

### 4.1 测试集评估（最终评估）

#### 预测过程

- 对测试集的每个组，使用该组的历史窗口预测当前窗口
- **确保不跨组预测**

#### 评估指标

- Accuracy
- Precision
- Recall
- F1 Score
- AUC-ROC
- Average Precision
- 混淆矩阵

#### 分组分析

- 每个测试组的性能
- 不同组的表现差异

#### 时间序列分析

- 预测时间线可视化
- 真实标签 vs 预测标签
- 干预时机分析

### 4.2 可解释性分析

#### 1. SHAP值分析

- 计算特征重要性
- 可视化特征贡献

#### 2. 注意力可视化（Transformer）

- 可视化注意力权重
- 识别模型关注的时间点

#### 3. HMM状态分析

- 状态转移图
- 状态持续时间分布
- 状态与干预的关系

#### 4. 案例研究

- 选择几个典型组
- 详细分析预测过程
- 可视化特征变化和状态转换

### 4.3 报告生成

#### 1. 数据划分报告

- 各组数据量
- 标签分布

#### 2. 无监督特征选择报告（阶段1）

- 选择的Top-K特征列表
- 特征重要性排序（基于无监督方法）
- 各方法的特征重要性对比

#### 3. HMM分析报告

- 状态分布
- 状态转移矩阵
- 状态与任务性能的关系

#### 4. 有监督特征重要性分析报告（阶段2.5）

- 最终选择的Top-M特征列表（M ≤ K）
- 各方法的特征重要性排序（树模型、互信息、RFE、LASSO、SHAP）
- 综合评分结果
- 特征选择前后性能对比（在训练验证集上）

#### 5. 模型性能报告

- 训练过程曲线
- 验证集性能
- 测试集性能
- 混淆矩阵

#### 6. 可视化

- 无监督特征重要性图（阶段1）
- 有监督特征重要性图（阶段2.5）
- 训练曲线
- 混淆矩阵
- 预测时间线（几个典型组）
- HMM状态转移图
- SHAP值分析图

---

## 关键技术点总结

### 1. 数据划分

- ✅ 按组划分：训练组8组、验证组2组、测试组2组
- ✅ 训练组内按时间划分：前70%训练，后30%训练验证
- ✅ 每个组的时间序列独立处理

### 2. 特征选择（两阶段）

- ✅ **阶段1：无监督方法**：方差、相关性、PCA、聚类、互信息
  - 初步筛选，选择Top-K特征
- ✅ **阶段2.5：有监督方法**：树模型、互信息、RFE、LASSO、SHAP
  - 使用HMM得到的Y标签进行有监督特征重要性分析
  - 进一步优化，选择Top-M特征（M ≤ K）
- ✅ 仅使用训练集进行特征选择

### 3. HMM建模

- ✅ 层次化设计：粗粒度3-4状态 + 低通信细粒度2-3状态
- ✅ 使用阶段1选择的Top-K特征训练
- ✅ 仅使用训练集训练
- ✅ 对所有数据预测Y标签

### 4. 时间序列模型

- ✅ 每个组独立构建序列
- ✅ 不跨组创建序列
- ✅ 使用历史窗口预测当前窗口
- ✅ 训练验证集用于early stopping

### 5. 评估流程

- ✅ 训练集：训练模型
- ✅ 训练验证集：Early stopping
- ✅ 验证集：模型选择
- ✅ 测试集：最终评估

---

## 数据流图

```
原始数据
  ↓
数据划分（按组 + 组内时间）
  ├─→ 训练集（训练组前70%）
  ├─→ 训练验证集（训练组后30%）
  ├─→ 验证集（验证组全部）
  └─→ 测试集（测试组全部）
  ↓
阶段1：无监督特征选择（仅使用训练集）
  - 方差分析、相关性分析
  - PCA、聚类、互信息
  - 选择Top-K特征
  ↓
阶段2：HMM训练（仅使用训练集，Top-K特征）
  ↓
阶段2：HMM预测（所有数据集，Top-K特征）
  ├─→ Y_train
  ├─→ Y_train_val
  ├─→ Y_val
  └─→ Y_test
  ↓
阶段2.5：有监督特征重要性分析（仅使用训练集）
  - 使用Y_train进行有监督分析
  - 树模型、互信息、RFE、LASSO、SHAP
  - 选择Top-M特征（M ≤ K，最终特征）
  ↓
阶段3：序列构建（每个组独立，使用Top-M特征）
  ├─→ X_train, Y_train
  ├─→ X_train_val, Y_train_val
  ├─→ X_val, Y_val
  └─→ X_test, Y_test
  ↓
阶段3：时间序列模型训练（LSTM/GRU/Transformer）
  - 使用训练集训练
  - 使用训练验证集进行early stopping
  ↓
模型选择（验证集）
  ↓
最终评估（测试集）
  ↓
报告生成
```

---

## 数据量估算

假设每组平均30个窗口（5-10分钟，32秒窗口）：

```
训练集：8组 × 30窗口 × 70% = 168窗口
训练验证集：8组 × 30窗口 × 30% = 72窗口
验证集：2组 × 30窗口 = 60窗口
测试集：2组 × 30窗口 = 60窗口

总计：360窗口
```

对于时间序列模型（序列长度10）：

```
训练序列：168 - 10 = 158个序列
训练验证序列：72 - 10 = 62个序列
验证序列：60 - 10 = 50个序列
测试序列：60 - 10 = 50个序列
```

数据量基本足够。

---

## 实施检查清单

### 阶段0：数据准备

- [ ] 加载三个数据源
- [ ] 按组划分数据（8/2/2）
- [ ] 训练组内按时间划分（70%/30%）
- [ ] 特征工程（聚合、整合、标准化）
- [ ] 数据质量检查

### 阶段1：特征选择

- [ ] 方差分析
- [ ] 相关性分析
- [ ] PCA分析
- [ ] 聚类分析
- [ ] 互信息分析
- [ ] 选择Top-K特征
- [ ] 生成特征选择报告

### 阶段2：HMM建模

- [ ] 训练粗粒度HMM（3-4状态，使用Top-K特征）
- [ ] 训练细粒度HMM（低通信状态细分）
- [ ] 预测所有数据的Y标签
- [ ] HMM状态分析
- [ ] 生成HMM分析报告

### 阶段2.5：有监督特征重要性分析

- [ ] 基于树模型的特征重要性（使用Y_train）
- [ ] 互信息分析（特征与Y_train）
- [ ] 递归特征消除（RFE）
- [ ] LASSO正则化
- [ ] SHAP值分析
- [ ] 综合评分并选择Top-M特征（M ≤ K）
- [ ] 在训练验证集上验证特征选择效果
- [ ] 生成有监督特征选择报告

### 阶段3：时间序列模型

- [ ] 为每个组独立构建序列
- [ ] 实现LSTM模型
- [ ] 实现GRU模型
- [ ] 实现Transformer模型
- [ ] 训练所有模型
- [ ] 在验证集上选择最佳模型

### 阶段4：评估与报告

- [ ] 测试集评估
- [ ] SHAP值分析
- [ ] 注意力可视化
- [ ] 案例研究
- [ ] 生成完整报告
- [ ] 生成所有可视化

---

## 注意事项

1. **组独立性**：所有时间序列操作必须在组内进行，不能跨组
2. **数据泄露**：测试集绝对不能用于任何训练过程
3. **时间顺序**：序列构建必须保持时间顺序
4. **数据不平衡**：使用F1 Score作为主要评估指标
5. **特征标准化**：使用训练集的统计量标准化所有数据
6. **HMM训练**：仅使用训练集训练HMM（使用阶段1的Top-K特征），然后预测所有数据
7. **两阶段特征选择**：
   - 阶段1：无监督特征选择（无Y标签）→ 选择Top-K特征用于HMM
   - 阶段2.5：有监督特征重要性分析（有Y标签）→ 选择Top-M特征（M ≤ K）用于时间序列模型
   - 两阶段都仅使用训练集进行特征选择

---

## 预期输出文件

### 数据文件

- `train_data.csv`：训练集数据
- `train_val_data.csv`：训练验证集数据
- `val_data.csv`：验证集数据
- `test_data.csv`：测试集数据
- `selected_features_stage1.csv`：阶段1选择的Top-K特征列表
- `selected_features_final.csv`：阶段2.5最终选择的Top-M特征列表

### 模型文件

- `hmm_model.pkl`：训练好的HMM模型
- `best_lstm_model.h5`：最佳LSTM模型
- `best_gru_model.h5`：最佳GRU模型
- `best_transformer_model.h5`：最佳Transformer模型

### 报告文件

- `data_split_report.txt`：数据划分报告
- `feature_selection_unsupervised_report.txt`：阶段1无监督特征选择报告
- `hmm_analysis_report.txt`：HMM分析报告
- `feature_selection_supervised_report.txt`：阶段2.5有监督特征重要性分析报告
- `model_performance_report.txt`：模型性能报告
- `final_evaluation_report.txt`：最终评估报告

### 可视化文件

- `feature_importance_unsupervised.png`：阶段1无监督特征重要性图
- `feature_importance_supervised.png`：阶段2.5有监督特征重要性图
- `training_curves.png`：训练曲线
- `confusion_matrices.png`：混淆矩阵
- `hmm_state_transitions.png`：HMM状态转移图
- `prediction_timelines_group_*.png`：各组的预测时间线
- `shap_analysis.png`：SHAP值分析图

---

**文档版本**：v1.0
**最后更新**：2025年1月
**作者**：Wayde
